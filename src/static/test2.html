<!DOCTYPE html>
<html>
  <body>
    <canvas
      id="myCanvas"
      width="400"
      height="400"
      style="border: 1px solid #d3d3d3"
    >
      Your browser does not support the canvas element.
    </canvas>

    <script>
      console.log(">>>> start");
      var canvas = document.getElementById("myCanvas");
      var context = canvas.getContext("2d");

      CanvasRenderingContext2D.prototype.fillTextVertical = function (
        text,
        x,
        y
      ) {
        var context = this;
        var canvas = context.canvas;

        var arrText = text.split("");
        var arrWidth = arrText.map(function (letter) {
          return context.measureText(letter).width;
        });

        var align = context.textAlign;
        var baseline = context.textBaseline;

        if (align == "left") {
          x = x + Math.max.apply(null, arrWidth) / 2;
        } else if (align == "right") {
          x = x - Math.max.apply(null, arrWidth) / 2;
        }

        x = 16;
        if (
          baseline == "bottom" ||
          baseline == "alphabetic" ||
          baseline == "ideographic"
        ) {
          y = y - arrWidth[0] / 2;
        } else if (baseline == "top" || baseline == "hanging") {
          y = y + arrWidth[0] / 2;
        }

        context.textAlign = "center";
        context.textBaseline = "middle";

        // 开始逐字绘制
        arrText.forEach(function (letter, index) {
          // 确定下一个字符的纵坐标位置
          var letterWidth = arrWidth[index];
          // 是否需要旋转判断
          var code = letter.charCodeAt(0);

          context.translate(x, y);
          // 英文字符，旋转90°
          context.rotate((-90 * Math.PI) / 180);
          context.translate(-x, -y);

          console.log(">>>> y fillText", letter, x, y);
          context.fillText(letter, x, y);

          // 旋转坐标系还原成初始态
          context.setTransform(1, 0, 0, 1, 0, 0);
          // context.rotate((90 * Math.PI) / 180);
          // 确定下一个字符的纵坐标位置
          var letterWidth = arrWidth[index];
          y = y + letterWidth;
        });
        // 水平垂直对齐方式还原
        context.textAlign = align;
        context.textBaseline = baseline;
      };

      context.font = "24px STKaiti, sans-serif";
      context.textAlign = "center";
      context.textBaseline = "top";
      context.fillTextVertical("测试", canvas.width / 2, 0);
    </script>
  </body>
</html>
