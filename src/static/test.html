<!DOCTYPE html>
<html>
  <body>
    <canvas
      id="myCanvas"
      width="400"
      height="400"
      style="border: 1px solid #d3d3d3"
    >
      Your browser does not support the canvas element.
    </canvas>

    <script>
      console.log(">>>> start");
      var canvas = document.getElementById("myCanvas");
      var context = canvas.getContext("2d");

      CanvasRenderingContext2D.prototype.wrapText = function (
        text,
        x,
        y,
        maxWidth,
        lineHeight
      ) {
        if (
          typeof text != "string" ||
          typeof x != "number" ||
          typeof y != "number"
        ) {
          return;
        }

        var context = this;
        var canvas = context.canvas;

        if (typeof maxWidth == "undefined") {
          maxWidth = (canvas && canvas.width) || 300;
        }
        if (typeof lineHeight == "undefined") {
          lineHeight =
            (canvas && parseInt(window.getComputedStyle(canvas).lineHeight)) ||
            parseInt(window.getComputedStyle(document.body).lineHeight) ||
            16;
        }

        // 字符分隔为数组
        var arrText = text.split("");
        var line = "";

        for (var n = 0; n < arrText.length; n++) {
          var testLine = line + arrText[n];
          var metrics = context.measureText(testLine);
          var testWidth = metrics.width;
          if (testWidth > maxWidth && n > 0) {
            context.fillText(line, x, y);
            line = arrText[n];
            y += lineHeight;
          } else {
            line = testLine;
          }
        }
        context.fillText(line, x, y);
      };

      CanvasRenderingContext2D.prototype.fillTextVertical = function (
        text,
        x,
        y
      ) {
        var context = this;
        var canvas = context.canvas;

        var arrText = text.split("");
        var arrWidth = arrText.map(function (letter) {
          return context.measureText(letter).width;
        });

        var align = context.textAlign;
        var baseline = context.textBaseline;

        if (align == "left") {
          x = x + Math.max.apply(null, arrWidth) / 2;
        } else if (align == "right") {
          x = x - Math.max.apply(null, arrWidth) / 2;
        }
        if (
          baseline == "bottom" ||
          baseline == "alphabetic" ||
          baseline == "ideographic"
        ) {
          y = y - arrWidth[0] / 2;
        } else if (baseline == "top" || baseline == "hanging") {
          y = y + arrWidth[0] / 2;
        }

        context.textAlign = "center";
        context.textBaseline = "middle";

        // 开始逐字绘制
        arrText.forEach(function (letter, index) {
          // 确定下一个字符的纵坐标位置
          var letterWidth = arrWidth[index];
          // 是否需要旋转判断
          var code = letter.charCodeAt(0);

          // console.log(">>> code", letter, index, code);

          context.translate(x, y);
          // 英文字符，旋转90°
          context.rotate((90 * Math.PI) / 180);
          context.translate(-x, -y);

          if (code <= 256) {
          } else if (index > 0 && text.charCodeAt(index - 1) < 256) {
            // y修正
            // context.translate(x, y);
            // // 英文字符，旋转90°
            // context.rotate((90 * Math.PI) / 180);
            // context.translate(-x, -y);

            y = y + arrWidth[index - 1] / 2;
          }

          console.log(">>>> y fillText", letter, x, y);
          context.fillText(letter, x, y);
          // 旋转坐标系还原成初始态
          context.setTransform(1, 0, 0, 1, 0, 0);
          // 确定下一个字符的纵坐标位置
          var letterWidth = arrWidth[index];
          y = y + letterWidth;
        });
        // 水平垂直对齐方式还原
        context.textAlign = align;
        context.textBaseline = baseline;
      };

      CanvasRenderingContext2D.prototype.fillTextHorizontal = function (
        text,
        x,
        y
      ) {
        var context = this;
        var canvas = context.canvas;

        var arrText = text.split("");
        var arrWidth = arrText.map(function (letter) {
          return context.measureText(letter).width;
        });

        var align = context.textAlign;
        var baseline = context.textBaseline;

        if (align == "left") {
          x = x + Math.max.apply(null, arrWidth) / 2;
        } else if (align == "right") {
          x = x - Math.max.apply(null, arrWidth) / 2;
        }
        if (
          baseline == "bottom" ||
          baseline == "alphabetic" ||
          baseline == "ideographic"
        ) {
          y = y - arrWidth[0] / 2;
        } else if (baseline == "top" || baseline == "hanging") {
          y = y + arrWidth[0] / 2;
        }

        context.textAlign = "center";
        context.textBaseline = "middle";

        // 开始逐字绘制
        arrText.forEach(function (letter, index) {
          // 确定下一个字符的纵坐标位置
          var letterWidth = arrWidth[index];
          // 是否需要旋转判断
          var code = letter.charCodeAt(0);

          // console.log(">>> code", letter, index, code);

          if (code <= 256) {
            context.translate(x, y);
            // 英文字符，旋转90°
            context.rotate((90 * Math.PI) / 180);
            context.translate(-x, -y);
          } else if (index > 0 && text.charCodeAt(index - 1) < 256) {
            // x修正
            x = x + arrWidth[index - 1] / 2;
          }

          console.log(">>>> x fillText", letter, x, y);
          context.fillText(letter, x, y);
          // 旋转坐标系还原成初始态
          context.setTransform(1, 0, 0, 1, 0, 0);
          // 确定下一个字符的纵坐标位置
          var letterWidth = arrWidth[index];
          y = y + letterWidth;
        });
        // 水平垂直对齐方式还原
        context.textAlign = align;
        context.textBaseline = baseline;
      };

      //   context.font = "32px sans-serif";
      //   context.fillText("我是一段被maxWidth限制的文本", 0, 50, 200);

      //   context.font = "16px sans-serif";
      //   context.textBaseline = "top";
      //   context.wrapText(
      //     "我是一段会换行的文字啦啦啦我是一段会换行的文字啦啦啦",
      //     0,
      //     0
      //   );

      context.font = "24px STKaiti, sans-serif";
      context.textAlign = "center";
      context.textBaseline = "top";
      // context.fillTextHorizontal("anglebaby和,黄晓明", canvas.width / 2, 0);
      context.fillTextVertical("anglebaby和黄晓明", canvas.width / 2, 0);
    </script>
  </body>
</html>
